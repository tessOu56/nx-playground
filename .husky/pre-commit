#!/usr/bin/env sh

echo "ğŸ” Running pre-commit checks..."

# é‹è¡Œ lint-staged (Prettier æ ¼å¼åŒ– + ESLint ä¿®å¾©)
echo "ğŸ“ Formatting code with Prettier and fixing ESLint issues..."
npx lint-staged

# æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„æ–‡ä»¶
if git diff --cached --quiet; then
    echo "âœ… No staged files to check"
    exit 0
fi

# é‹è¡Œ Nx affected lint æª¢æŸ¥ (åªæª¢æŸ¥å—å½±éŸ¿çš„é …ç›®)
echo "ğŸ”§ Running ESLint on affected projects..."
if ! npx nx affected --target=lint --fix; then
    echo "âŒ ESLint check failed"
    exit 1
fi

# é‹è¡Œ TypeScript é¡å‹æª¢æŸ¥ (åªæª¢æŸ¥å—å½±éŸ¿çš„é …ç›®)
echo "ğŸ” Running TypeScript type check on affected projects..."
if ! npx nx affected --target=typecheck; then
    echo "âŒ TypeScript type check failed"
    exit 1
fi

# é‹è¡Œ Jest æ¸¬è©¦ (åŒ…æ‹¬ mock data æ¸¬è©¦)
echo "ğŸ§ª Running Jest tests..."
if ! pnpm test:mock-data; then
    echo "âŒ Jest tests failed"
    exit 1
fi

# æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡
echo "ğŸ“Š Checking test coverage..."
if ! pnpm test:coverage --passWithNoTests; then
    echo "âŒ Test coverage check failed"
    exit 1
fi

echo "âœ… Pre-commit checks completed!"
